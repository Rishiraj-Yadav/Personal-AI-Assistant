version: '3.8'

services:
  backend:
    build: ./backend
    container_name: openclaw-backend
    ports:
      - "8000:8000"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.3-70b-versatile}
      - DEBUG=${DEBUG:-false}
      # CRITICAL FIX: Tell backend how to reach Desktop Agent on host
      - DESKTOP_AGENT_URL=http://host.docker.internal:7777
    volumes:
      - ./backend/app:/app/app
      - ./backend/logs:/app/logs
      - ${WORKSPACE_PATH:-./workspace}:/workspace
      - ./desktop-agent/config/api_key.txt:/app/desktop_agent_key.txt:ro
    extra_hosts:
      # CRITICAL FIX: Map host.docker.internal to host machine
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: openclaw-frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:8000/api/v1
    depends_on:
      - backend
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    restart: unless-stopped

networks:
  default:
    name: openclaw-network

# version: '3.8'

# services:
#   backend:
#     build: ./backend
#     container_name: openclaw-backend
#     ports:
#       - "8000:8000"
#     environment:
#       - GROQ_API_KEY=${GROQ_API_KEY}
#       - GROQ_MODEL=${GROQ_MODEL:-llama-3.3-70b-versatile}
#       - DEBUG=${DEBUG:-false}
#     volumes:
#       - ./backend/app:/app/app
#       - ./backend/logs:/app/logs
#       - workspace:/workspace  # Persistent workspace for file operations
#     restart: unless-stopped
#     healthcheck:
#       test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/v1/health')"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
#       start_period: 10s

#   frontend:
#     build:
#       context: ./frontend
#       dockerfile: Dockerfile
#     container_name: openclaw-frontend
#     ports:
#       - "3000:3000"
#     environment:
#       - VITE_API_URL=http://localhost:8000/api/v1
#     depends_on:
#       - backend
#     volumes:
#       - ./frontend/src:/app/src
#       - ./frontend/public:/app/public
#     restart: unless-stopped

# networks:
#   default:
#     name: openclaw-network

# volumes:
#   workspace:
#     driver: local